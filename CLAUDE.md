내 핸드폰을 가지고 원격 컴퓨터가 claude code를 사용해서 코딩하게 하고 싶어.

# 큰 구조
  - 핸드폰 (app): 안드로이드 앱. 내가 음성으로 스팩을 설명하면 나와 대화해서 구체적인 스팩을 완성하고, 정해진 형태의 요구사항을 만듦.
           여러 repository에 다른 작업을 요청할 수 있어야 함.
           중계 서버가 보내오는 작업의 결과를 요약해서 사용자에게 전달해야 함. 음성으로 읽어줄 수 있어야 함.
  - 중계 서버 (api server): 핸드폰과 개발을 할 수 있는 컴퓨를 중계함. 양쪽과 websocket으로 연결되어 있음.
  - 원격 개발 컴퓨터(Worker): 중계 서버에서 요청받은 작업을 claude code를 사용해 개발함.
           여러 repository에 대한 작업이 올 수 있음.
           각 작업을 진행하고 결과를 보고 해야 함.

# 사용자 앱 요구 사항
일단 안드로이드만 대상으로 만듦.
네이티브앱으로 개발하고, kotlin으로 개발.

## 로그인
"안녕! 천재 전경원이 만든 전경원 천재 만들기 프로젝트를 시작하자" 라고 음성 입력을 받음.
서버에 음성입력을 보내면 서버가 목소리를 분석해서 누구인지 판단하게 함.
서버가 누구인지 판단하면 이름을 알려줌. 사용자에게 이름을 확인함.
서버가 누구인지 모르겠다고 하면 사용자에게 이름을 물어보고 서버에 이름을 전달해서 회원 가입을 진행.

## 개발 컴퓨터의 현재 정보

가능한 프로젝트는 개발 컴퓨터가 알고 있다.
중계서버를 통해서 개발할 수 있는 프로젝트 목록을 얻어와야 한다.

진행중이던 작업이 있으면 그것도 개발 컴퓨터가 알고 있다.
중계 서버를 통해서 진행중이던 작업을 얻어와야 한다.

## 작업 수집

사용자에게 원하는 작업을 묻는다.
어떤 프로젝트인지, 어떤 내용의 개발을 하고 싶은지 묻는다.
사용자가 계속 대화 하며 원하는 것이 무엇인지 구체화 한다.

## 작업 요약

사용자에게서 수집한 내용을 바탕으로 요약을 하고 사용자에게 확인 받는다.
사용자가 승인하면 적절한 포맷으로 정리해서 서버에 전달한다.

# 중계 서버 요구 사항

## 로그인
사용자 앱에서 보내온 음성 파일을 분석해서 누구인지 판단해야 함.
"안녕! 천재 전경원이 만든 전경원 천재 만들기 프로젝트를 시작하자"라는 음성을 입력으로 받음.
openai api를 사용해서 "1. 인사를 하고 시작했는지, 2. '천재 전경원' 이라는 말이 들어갔는지, 3. 전경원을 천재로 만들려는 프로젝트인지" 를 확인함.
확인이 되면 기존에 저장했던 파일들과 비교해서 어느 목소리와 유사한지 판단.
유사한 목소리를 찾으면 그 사람으로 로그인
유사한 목소리가 없다면 앱에 누구인지 물어보고 회원 정보 저장.
회원 정보에는 사람 이름과 목소리 음성파일이 같이 저장되어야 함. (다음 로그인 때 비교해야 하기 때문)

## 사용자, 개발 컴퓨터 관리

중계 서버는 사용자와 개발 컴퓨터를 관리 해야 함.
개발 컴퓨터는 사용자에게 귀속되는 형태로 개발.
한 사용자에게 여러 개발 컴퓨터를 할당할 수 있어야 함.
프로젝트 마다 특정 개발 컴퓨터에 연결해야 함. (모르겠으면 사용자에게 어디서 개발할지 물어봐야 함.)
예를 들어 "A프로젝트에 대한 수정"이 있을 때 X컴퓨터일지, Y컴퓨터일지 알 수 있어야 함.

## 요구 사항 중계

앱과 개발 컴퓨터의 요청을 중계해야 함.
중계는 모두 명확한 api로 이루어져있어야 함.

앱이 필요한 주요 api (더 있을 수 있음)
  - 사용가능한 개발 컴퓨터
  - 사용 가능한 프로젝트
  - 진행중인 작업 상태
  - 최근 진행했던 작업 목록
  - 작업 진행 (가장 중요한 작업)

개발 컴퓨터 주요 api
  - 개발 진행 중 사용자의 결정이 필요한 것을 요청
  - 결과를 요약해서 반환

# 개발 컴퓨터 요구사항

지금 이 프로젝트는 asp.net core로 만들어 졌지만,
Console application이라고 생각하고 개발해야 함.
Web으로 만든 이유는 이 프로그램을 단독으로 사용했을 때,
테스트 및 사용성을 편하게 하기 위해서 만듦.
작업 요청 서버에 연결하지 않아도 로컬에서 웹페이지로 작업 요청 테스트를 하기 위함.

**로컬 웹 테스트 UI**:
  - 좌측 사이드바 네비게이션: "작업 관리", "프로젝트" 메뉴 제공
  - Split View 레이아웃: 좌측(작업 생성/목록), 우측(상세 정보)
  - 탭 메뉴: "새 작업", "진행 중", "작업 이력" 탭으로 구성
  - 작업 항목 클릭 시 우측에 상세 정보 표시 (설명, 결과, 에러, 로그)
  - JavaScript 파일 분리: `projects.js`, `jobs.js`, `job-detail.js`

## 프로그램의 목적
 - 외부 작업 요청 서버로부터 작업을 받아와서 다른 디렉토리에서 claude code를 활용해 작업을 수행시킨다.
 - 한 번에 여러 디렉토리에 작업을 요청할 수 있어야 한다.
 - 각각의 작업이 끝나면 작업 요청 서버에 작업의 결과물을 보고한다.

## 작업 요청 서버와의 통신
 - websocket 통신을 한다.
 - 인증은 없다.
 - 지금 worker가 관리하고 있는 프로젝트와 작업 중인 내용을 보고해야 함.
 - 작업 요청 서버가 작업을 시키면 해당 작업을 수행해야 함.
 - 작업 요청은 정해진 포맷으로 전달 함.
 - 작업 결과도 일정한 포맷으로 전달 해야 함.

## 폴더 경로
/workspace
  - /JobStatus: 현재 실행중인 작업 정보 저장
  - /JobHistory: 과거 실행했던 작업 정보 저장
  - /RemoteProgrammer/src/Worker
    - Worker.slnx
    - /Worker
      - Worker.csproj
  - /Project1
  - /Project2

**경로 관리**: 모든 프로젝트 경로는 절대경로로 변환하여 사용함. `Path.GetFullPath()`를 사용하여 경로 혼동을 방지.

## 프로젝트 관리
  - worker는 다른 프로젝트가 무엇이 있는지,
    어떤 작업을 수행 중인지
    어떤 작업을 수행했었는지 관리해야 함.
  - 자기 자신을 수정할 수도 있어야 함.
  - RemoteProgrammer프로젝트 내부의 다른 프로그램도 수정할 수 있어야 함.
  - 모든 프로젝트는 git으로 관리하고 있음.

## 작업 진행
  - 서버로 부터 작업 요청을 받으면 해당 폴더에서 claude code를 사용해서 작업을 실행 함.
  - 멀티 플랫폼 지원: Windows(PowerShell), Linux/macOS(Bash) 모두 지원
      - 전략 패턴 사용: `IClaudeExecutionStrategy` 인터페이스
      - `WindowsClaudeExecutionStrategy`: PowerShell 스크립트 (.ps1)
      - `UnixClaudeExecutionStrategy`: Bash 스크립트 (.sh)
      - Program.cs에서 OS 자동 감지하여 적절한 전략 주입
  - 작업 설명 전달: heredoc 방식으로 여러 줄 텍스트를 안전하게 Claude Code에 전달
      - bash heredoc 또는 PowerShell here-string 사용
      - 여러 줄 입력 시 각 줄이 별도 명령으로 실행되는 오류 방지
  - 중간중간 사용자가 정해야 할 결정사항이 있으면 중계서버를 통해서 사용자에게 문의할 수 있어야 함.
      사용자가 답변한 내용을 바탕으로 내용을 진행.

## 큰작업(Big Task) 관리

Worker는 "큰작업" 단위로 작업을 관리합니다.

### 큰작업이란?
- 여러 개의 작은 작업(Job)을 포함하는 논리적인 작업 단위
- 하나의 Git 브랜치와 1:1로 매핑
- 예: "feature-login", "refactor-api", "bugfix-123"

### Git Worktree 사용
- 각 큰작업(브랜치)은 별도의 Git worktree에서 실행됨
- Worktree 위치: `/workspace/.worktrees/{project}/{branch}/`
- 같은 큰작업의 작업들은 순차적으로 실행 (동시 실행 불가)
- Worktree는 작업 완료 후에도 유지되어 재사용

### 작업 흐름
1. 사용자가 작업 생성 시 브랜치 이름 필수 입력
2. GitWorktreeManager가 해당 브랜치의 worktree 생성/조회
3. Worktree 상태를 InUse로 변경 (동시 실행 방지)
4. Claude Code가 worktree에서 작업 수행
5. 작업 완료 후 Worktree 상태를 Active로 복구

### Worktree 관리
- Worktree는 자동으로 삭제되지 않음 (재사용 최대화)
- 사용자가 UI에서 직접 삭제 가능
- 메타데이터: `/workspace/.worktrees/.metadata/`

### 동시 실행 제약
- 같은 브랜치에서는 한 번에 하나의 작업만 실행 가능
- 다른 브랜치는 동시 실행 가능

### 브랜치 이름 규칙
- 허용: 영문, 숫자, 한글, -, _, /
- 금지: .., @{, 시작/끝에 ., 끝에 .lock
- 길이: 1-100자

## 작업 결과 공유 (에러 공유)
  - 사용자에게 작업 결과를 요약해서 공유.
  - 사용자는 결과를 듣고 수정사항을 지시할 수 있음.
  - 개발 서버는 수정 사항을 요청 받으면 이어서 작업을 진행.